#!/usr/bin/env bash

set -euo pipefail

echo "Running pre-commit checks..."

# 1. cargo fmt â€” auto-fix and re-stage changed files
if ! cargo fmt -- --check 2>/dev/null; then
    echo "rustfmt: auto-fixing formatting..."
    cargo fmt
    # Re-stage only the .rs files that were already staged
    git diff --name-only --cached -- '*.rs' | xargs -r git add
    echo "rustfmt: fixed and re-staged."
fi

# 2. cargo clippy
if ! cargo clippy --all-targets --all-features -- -D warnings 2>/dev/null; then
    echo "error: clippy check failed. Fix warnings before committing." >&2
    exit 1
fi

# 3. Chain beads hook if bd is available
if command -v bd >/dev/null 2>&1; then
    bd hook pre-commit "$@"
fi
